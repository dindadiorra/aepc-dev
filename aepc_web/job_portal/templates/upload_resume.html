{% extends 'base.html' %}

{% block title %}Upload Resume{% endblock %}

{% block content %}
<section>
    <div class="container-sm" style="text-align:center">
        <h2 style="font-weight: bold;">Candidate Form</h2>
        <p>Upload your resume and fill out the form.</p>
    </div>
    <div class="container-sm" style="max-width:800px;">
        <form id="upload-resume-form" method="POST" enctype="multipart/form-data" class="mb-4">
            {% csrf_token %}
            <div class="mb-3">
                <label for="cv" class="form-label">Upload CV (PDF/Word): </label>
                <input type="file" name="cv" id="cv" class="form-control" accept=".pdf,.doc,.docx" required>
            </div>
    
            <div class="mb-3">
                <label for="name" class="form-label" style="margin-top: 10px;">Full Name <span style="color:red;">*</span></label>
                <input type="text" name="name" id="name" class="form-control" required>
    
                <label for="email" class="form-label">Email Address: <span style="color:red;">*</span></label>
                <input type="email" name="email" id="email" class="form-control" required>
    
                <label for="phone_number" class="form-label">Phone Number: <span style="color:red;">*</span></label>
                <input type="tel" name="phone_number" id="phone_number" class="form-control" required>

                <label for="linkedin_url" class="form-label">LinkedIn Profile (Optional):</label>
                <input type="url" name="linkedin_url" id="linkedin_url" class="form-control">
    
                <label for="address" class="form-label">Address: <span style="color:red;">*</span></label>
                <input type="text" name="address" id="address" class="form-control">
    
                <!-- <label for="degree" class="form-label">Degree: <span style="color:red;">*</span></label>
                <input type="text" name="degree" id="degree" class="form-control" required> -->

                <label for="degree" class="form-label">Degree: <span style="color:red;">*</span></label>
                <select id="degree" name="degree" class="form-select" required>
                    <option value="" selected disabled>Select your degree</option>
                    <option value="Diploma">Diploma Degree</option>
                    <option value="Associate">Associate Degree</option>
                    <option value="Bachelor">Bachelor's Degree</option>
                    <option value="Master">Master's Degree</option>
                    <option value="PhD">PhD (Doctorate)</option>
                    <option value="Other">Other (please specify)</option>
                </select>
                <!-- Input untuk degree tambahan -->
                <input
                    type="text"
                    id="other-degree"
                    name="other_degree"
                    class="form-control mt-2"
                    placeholder="Specify your degree"
                    style="display: none;"
                    required
                >
    
                <label for="major" class="form-label">Major: <span style="color:red;">*</span></label>
                <input type="text" name="major" id="major" class="form-control" required>
    
                <label for="gpa" class="form-label">GPA: <span style="color:red;">*</span></label>
                <input type="text" name="gpa" id="gpa" class="form-control" required>
    
                <label for="college_name" class="form-label">College Name: <span style="color:red;">*</span></label>
                <input type="text" name="college_name" id="college_name" class="form-control" required>

                <label for="curr_salary" class="form-label">Current Salary (Optional):</label>
                <input type="number" step="0.01" name="curr_salary" id="curr_salary" class="form-control">
            
                <label for="expected_salary" class="form-label">Expected Salary (Optional):</label>
                <input type="number" step="0.01" name="expected_salary" id="expected_salary" class="form-control">
            
                <label for="skills" class="form-label">Skills <span style="color:red;">*</span></label>
                <textarea name="skills" id="skills" class="form-control" rows="3" required></textarea>
            </div>
    
            <!-- Section for Adding Experience -->
            <div id="add-experience-section">
                <br>
                <div class="container">
                    <div class="row d-flex justify-content-between" style="padding-left: 0px;">
                        <h5 class="col-auto" style="font-weight: bold; text-align: left; margin-left: 0px;">Add Work Experience</h5>
                        <button type="button" id="add-experience-button" class="btn btn-success mb-3 col-auto">Add Experience</button>
                    </div>
                </div>
                <div id="experience-list"></div>
                <!-- Add New Experience Form -->
                <div class="mb-3" id="add-experience-form">
                    <label for="company_name" class="form-label">Company Name:</label>
                    <input type="text" name="company_name" id="company_name" class="form-control">

                    <label for="position" class="form-label">Position:</label>
                    <input type="text" name="position" id="position" class="form-control">

                    <label for="start_date" class="form-label">Start Date:</label>
                    <input type="date" name="start_date" id="start_date" class="form-control">

                    <label for="end_date" class="form-label">End Date:</label>
                    <input type="date" name="end_date" id="end_date" class="form-control">

                    <label for="description" class="form-label">Description:</label>
                    <textarea name="description" id="description" class="form-control" rows="4"></textarea>
                </div>
            </div>

            <button type="submit" class="btn btn-primary" style="background: #563768;">Submit</button>
        </form>
    </div>

    <div id="response-message"></div>
</section>

<script>
    // Array to hold experience data
    let experiences = [];

    // Handle form submission
document.getElementById('upload-resume-form').addEventListener('submit', function (e) {
    e.preventDefault();

    // Include any experiences added through the form in the experiences array
    const companyName = document.getElementById('company_name').value.trim();
    const position = document.getElementById('position').value.trim();
    const startDate = document.getElementById('start_date').value.trim();
    const endDate = document.getElementById('end_date').value.trim();
    const description = document.getElementById('description').value.trim();

    // Ensure we push the last experience (if any) before submitting
    if (companyName || position || startDate) {
        experiences.push({ companyName, position, startDate, endDate, description });
    }

    // Now append all experiences, including those added before the submit event
    const formData = new FormData(this);
    formData.append("experiences", JSON.stringify(experiences)); // Add all the experiences array

    // Submit the form with all experiences
    fetch("{% url 'upload_resume' %}", {
        method: "POST",
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            this.reset();
            experiences = []; // Reset after submission
            document.getElementById('experience-list').innerHTML = ''; // Clear the displayed experiences
        } else {
            alert(`Error: ${data.errors}`);
        }
    });
});

    // Add new experience to the list
    document.getElementById('add-experience-button').addEventListener('click', function () {
        const companyName = document.getElementById('company_name').value.trim();
        const position = document.getElementById('position').value.trim();
        const startDate = document.getElementById('start_date').value.trim();
        const endDate = document.getElementById('end_date').value.trim();
        const description = document.getElementById('description').value.trim();

        // Basic validation
        if (!companyName || !position || !startDate) {
            alert('Please fill in all required fields for experience.');
            return;
        }

        // Add the new experience to the array
        const newExperience = { companyName, position, startDate, endDate, description };
        experiences.push({newExperience});

        // Display the experience in the list
        const experienceList = document.getElementById('experience-list');
        const experienceItem = document.createElement('div');
        experienceItem.innerHTML = `
            <div class="mb-3">
                <strong>${companyName} - ${position}</strong><br>
                <em>${startDate} to ${endDate || 'Present'}</em><br>
                <p>${description}</p>
                <button type="button" class="btn btn-danger delete-experience">Delete</button>
            </div>
        `;
        experienceList.appendChild(experienceItem);

        experienceItem.querySelector('.delete-experience').addEventListener('click', function () {
            const index = Array.from(experienceList.children).indexOf(experienceItem);
            experiences.splice(index, 1);
            experienceItem.remove();
        });

        // Clear the experience input fields
        ['company_name', 'position', 'start_date', 'end_date', 'description'].forEach(id => {
            document.getElementById(id).value = '';
        });
    });

    // // Delete experience from the list
    // function deleteExperience(index) {
    //     experiences.splice(index, 1);  // Remove the experience at the specified index
    //     document.getElementById('experience-list').innerHTML = '';  // Clear the list
    //     experiences.forEach((exp, idx) => {
    //         const experienceList = document.getElementById('experience-list');
    //         const experienceItem = document.createElement('div');
    //         experienceItem.innerHTML = `
    //             <div class="mb-3">
    //                 <strong>${exp.companyName} - ${exp.position}</strong><br>
    //                 <em>${exp.startDate} to ${exp.endDate || 'Present'}</em><br>
    //                 <p>${exp.description}</p>
    //                 <button type="button" class="btn btn-danger btn-sm" onclick="deleteExperience(${idx})">Delete</button>
    //             </div>
    //         `;
    //         experienceList.appendChild(experienceItem);
    //     });
    // }

    document.getElementById('degree').addEventListener('change', function () {
        const otherDegreeInput = document.getElementById('other-degree');
        if (this.value === 'Other') {
            otherDegreeInput.style.display = 'block'; // Show input box
            otherDegreeInput.required = true; // Make it required
        } else {
            otherDegreeInput.style.display = 'none'; // Hide input box
            otherDegreeInput.value = ''; // Clear input value
            otherDegreeInput.required = false; // Remove required attribute
        }
    });
</script>
{% endblock %}
